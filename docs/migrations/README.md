# 数据库迁移脚本使用说明

## 📋 目录

1. [SKU表结构扩展](#sku表结构扩展)
2. [商品数据迁移](#商品数据迁移)
3. [执行顺序](#执行顺序)

---

## 🔧 SKU表结构扩展

### 文件
- `add_sku_fields_20260112.sql` - SQL版本
- `run_migration.php` - PHP执行器

### 功能
扩展 `mrs_sku` 表，添加以下字段：
- `sku_name_cn` - 中文名称
- `sku_name_es` - 西班牙语名称
- `product_category` - 产品类别（包材/原物料/半成品/成品）
- `barcode` - 条码
- `shelf_life_months` - 保质期效（月）
- `supplier_country` - 供货商国家（中国/西班牙）

### 执行方式

#### 方式一：PHP执行器（推荐）
```bash
php docs/migrations/run_migration.php
```

#### 方式二：直接执行SQL
```bash
mysql -h <host> -u <user> -p < docs/migrations/add_sku_fields_20260112.sql
```

---

## 📦 商品数据迁移

将现有库存中的商品名称批量导入到新的SKU表中。

### 提供三种迁移脚本

#### 1. 简单迁移（SQL版本）
**文件**: `migrate_products_to_sku_20260112.sql`

**数据来源**: `mrs_package_items` 表

**执行方式**:
```bash
mysql -h <host> -u <user> -p < docs/migrations/migrate_products_to_sku_20260112.sql
```

**特点**:
- ✓ 简单快速
- ✓ 自动生成SKU编码
- ✓ 自动去重
- ✗ 无交互确认
- ✗ 错误处理较弱

---

#### 2. 基础迁移（PHP版本）
**文件**: `migrate_products_to_sku.php`

**数据来源**: `mrs_package_items` 表

**执行方式**:
```bash
php docs/migrations/migrate_products_to_sku.php
```

**特点**:
- ✓ 详细的执行日志
- ✓ 实时显示进度
- ✓ 事务保护
- ✓ 错误统计
- ✓ 自动生成SKU编码
- ✗ 无交互确认

**输出示例**:
```
========================================
商品名称迁移到SKU表
========================================

步骤 1: 获取现有库存中的所有唯一商品名称...
找到 125 个唯一商品名称

步骤 2: 检查已存在的SKU...
已存在 30 个SKU
需要新增 95 个SKU

步骤 3: 开始批量插入新商品...
  ✓ 番茄酱 (SKU: AUTO-123456)
  ✓ 橄榄油 (SKU: AUTO-234567)
  ...

========================================
迁移完成！
========================================
成功: 95 个
失败: 0 个
```

---

#### 3. 综合迁移（PHP版本）⭐ 推荐
**文件**: `migrate_all_products_to_sku.php`

**数据来源**:
- `mrs_package_items` 表（包裹产品明细）
- `mrs_package_ledger` 表（包裹台账）

**执行方式**:
```bash
php docs/migrations/migrate_all_products_to_sku.php
```

**特点**:
- ✓ **最全面的数据收集**
- ✓ 从多个表提取商品名称
- ✓ **交互式确认**
- ✓ 详细的执行日志
- ✓ 预览待迁移数据
- ✓ 实时进度显示
- ✓ 事务保护
- ✓ 完整的统计报告

**执行流程**:
```
========================================
综合迁移：商品名称 → SKU表
========================================

步骤 1: 收集所有商品名称...
  - 从 mrs_package_items 提取...
    找到 125 个
  - 从 mrs_package_ledger 提取...
    找到 85 个

合计找到 180 个唯一商品名称

步骤 2: 检查已存在的SKU...
已存在 30 个SKU
需要新增 150 个SKU

待新增的商品列表（前10个）：
  1. 番茄酱
  2. 橄榄油
  3. 红酒
  ... 还有 140 个

是否继续执行迁移？[Y/n]: Y

步骤 3: 开始批量插入新商品...
  ✓ [1/150] 番茄酱 (SKU: AUTO-260112-0001)
  ✓ [2/150] 橄榄油 (SKU: AUTO-260112-0002)
  ...

========================================
迁移完成！
========================================
✓ 成功: 150 个

当前SKU表统计：
  总计: 180 个SKU
  使用中: 180 个
  已停用: 0 个
  已设置产品类别: 0 个
  已设置条码: 0 个
  已设置保质期: 0 个

✓ 迁移成功！接下来可以在SKU管理页面中完善各个SKU的详细信息。
```

---

## 🚀 执行顺序

### 标准迁移流程

#### Step 1: 扩展表结构
```bash
php docs/migrations/run_migration.php
```

#### Step 2: 迁移商品数据（三选一）

**推荐方式**（最全面）:
```bash
php docs/migrations/migrate_all_products_to_sku.php
```

**快速方式**（SQL直接执行）:
```bash
mysql -h <host> -u <user> -p < docs/migrations/migrate_products_to_sku_20260112.sql
```

**基础方式**（PHP单表迁移）:
```bash
php docs/migrations/migrate_products_to_sku.php
```

---

## ⚠️ 注意事项

1. **备份数据库**
   ```bash
   mysqldump -h <host> -u <user> -p <database> > backup_$(date +%Y%m%d).sql
   ```

2. **执行前检查**
   - 确保数据库连接正常
   - 确认有足够的权限（ALTER TABLE, INSERT）
   - 确认 `mrs_sku` 表存在

3. **执行后验证**
   - 访问 MRS 后台 → 基础设置 → SKU管理
   - 检查商品是否正确导入
   - 完善SKU详细信息（类别、条码、保质期等）

4. **重复执行**
   - 所有脚本都支持重复执行
   - 已存在的SKU不会重复插入
   - 使用事务保护，失败会回滚

---

## 📝 后续工作

迁移完成后，建议在 SKU 管理页面中完善以下信息：

- [ ] 设置产品类别（包材/原物料/半成品/成品）
- [ ] 录入产品条码
- [ ] 设置保质期效（月）
- [ ] 补充西班牙语名称
- [ ] 填写整箱规格
- [ ] 设置供货商国家
- [ ] 完善备注信息

---

## 🆘 常见问题

### Q1: 执行迁移脚本时提示"数据库连接失败"
**A**: 检查 `app/mrs/config_mrs/env_mrs.php` 中的数据库配置是否正确。

### Q2: 迁移后商品重复了怎么办？
**A**: 脚本会自动去重，不会插入已存在的商品。如果发现重复，可能是商品名称有微小差异（空格、大小写等）。

### Q3: 可以多次执行迁移脚本吗？
**A**: 可以。脚本会自动跳过已存在的SKU，只插入新的商品。

### Q4: 迁移失败了怎么办？
**A**: 使用PHP脚本时会自动回滚，不会产生脏数据。检查错误日志，修复问题后重新执行。

---

## 📧 技术支持

如有问题，请查看执行日志中的详细错误信息，或联系系统管理员。
