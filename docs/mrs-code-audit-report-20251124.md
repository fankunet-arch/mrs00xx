# MRS 物料收发管理系统代码审计报告

**报告日期**: 2025-11-24
**审计员**: Jules (AI Assistant)
**版本**: v1.0

## 1. 审计范围
本次审计范围涵盖了 MRS 项目的整个代码库，包括后端 PHP 应用程序 (`app/mrs/`)、前端 JavaScript (`dc_html/mrs/js/`)、API 网关 (`dc_html/mrs/api.php`) 以及项目文档 (`docs/`)。

## 2. 总体评估
MRS 系统是一个功能完整、代码质量高且具备良好安全实践的应用程序。后端代码尤为出色，展现了在安全性、健壮性和可维护性方面的专业水准。前端虽然在技术栈上略显传统，但成功地实现了所有核心业务需求，并同样遵循了基本的安全原则。

**优点**:
- **强大的安全性**: 全面应用了防SQL注入、防XSS、防会话固定、密码安全存储和暴力破解防护等关键安全措施。
- **高质量的后端代码**: 后端逻辑清晰，错误处理和日志记录完善，并包含了优雅降级和自愈机制等高级特性。
- **功能完整**: 系统的核心业务流程（入库、出库、库存管理）均已实现。
- **优秀的文档**: 项目文档与代码实现高度一致，为开发和维护提供了有力支持。

**待改进项**:
- **安全风险**: 存在硬编码的数据库凭证，这是当前系统最主要的安全风险。
- **前端架构**: 后台 JavaScript (`backend.js`) 文件过于庞大，不利于长期维护。
- **功能完整性**: 部分规划中的功能尚未完全实现。

## 3. 审计发现详解

### 3.1 逻辑与功能问题

#### 3.1.1 已实现但文档未记录的功能
- **库存盘点/调整**: 代码中已实现 `backend_adjust_inventory.php` 接口和相应的前端模态框，允许用户对单个 SKU 的库存进行盘点和调整。这是一个核心的库存管理功能。
- **SKU 履历**: 代码中已实现 `backend_sku_history.php` 接口和前端查看功能，可以追溯物料的每一次库存变动。

#### 3.1.2 功能开发中 (In-Progress)
以下功能在代码或UI中已有体现，但尚未完全实现或存在缺陷：
- **统计报表 (`page-reports`)**: 前端仅有UI入口 (`loadReports` 函数为空)，后端 API (`backend_reports.php`) 的逻辑需要完善。
- **"记住我" 功能**: 登录页的 "记住我" 选项仅在客户端设置了一个标记性的 cookie，并未实现安全的、基于 token 的持续认证机制。当前状态下，该功能是不安全的。
- **查看原始记录**: 在后台的“合并确认”页面，`viewRawRecords` 函数是空的，用户无法查看构成汇总数据的原始录入条目。
- **用户管理**: 系统没有提供用户增删改查的管理界面，依赖于数据库的直接操作。
- **操作员识别**: 在“极速收货”页面 (`receipt.js`)，操作员姓名被硬编码为 `'操作员'`，缺乏与用户系统的联动。

### 3.2 数据连接与安全性

#### 3.2.1 高风险 (High Risk)
- **硬编码的数据库凭证**: 在 `app/mrs/config_mrs/env_mrs.php` 文件中，默认的数据库密码被硬编码。虽然系统支持使用环境变量覆盖，但这仍然是一个重大安全隐患，尤其是在代码仓库的访问控制不严格的情况下。
    - **建议**: 立即从代码中移除硬编码的凭证，并强制要求在所有部署环境中使用环境变量进行配置。

#### 3.2.2 中风险 (Medium Risk)
- **无。**

#### 3.2.3 已遵循的最佳实践 (Good Practices)
- **SQL 注入防护**: 所有数据库查询均使用 PDO 预处理语句和参数绑定。
- **密码安全**: 使用 `password_hash()` 和 `password_verify()` 处理用户密码，算法为 `PASSWORD_DEFAULT` (Bcrypt)。
- **会话管理**: 实施了全面的会话安全措施，包括 `HTTPOnly`, `Secure`, `SameSite=Strict` 的 cookie 设置，以及 `session_regenerate_id()` 防会话固定攻击。
- **API 安全**: 统一的 API 网关 (`api.php`) 对路由参数进行了严格的白名单校验，有效防止了目录遍历攻击。
- **跨站脚本 (XSS) 防护**: 前端在渲染用户输入或数据库数据时，普遍使用了 HTML 转义函数。
- **暴力破解防护**: 登录接口包含限流机制（5分钟5次）。
- **访问控制**: 通过 `defined('MRS_ENTRY')` 和 `is_user_logged_in()` 对后台 API 进行了有效的访问控制。

### 3.3 前端代码质量
- **单体结构**: `dc_html/mrs/js/backend.js` 文件超过1000行，几乎包含了所有后台页面的逻辑。这使得代码难以导航、调试和扩展。
    - **建议**: 在未来的开发中，应考虑引入模块化方案（如 ES6 Modules）或前端框架（如 Vue, React）对代码进行重构。
- **过时的实践**: 代码中大量使用 `onclick` 内联事件处理器和手动的 `innerHTML` 操作。虽然在当前项目中功能正常，但这不符合现代前端开发的最佳实践。
- **代码一致性**: `backend.js` 使用了自定义的 `showAlert` 函数来显示美观的通知，而 `receipt.js` 则使用原生的 `alert()`，体验不一致。

## 4. 结论与建议
MRS 系统是一个健壮且安全的应用程序，其后端质量达到了很高的标准。当前的首要任务是解决硬编码数据库凭证这一高风险安全问题。

其次，建议团队为“开发中”的功能制定明确的开发计划，并考虑对前端代码进行现代化重构，以提高长期可维护性。

总的来说，该项目基础扎实，只需解决少数关键问题并继续完善未完成的功能，即可成为一个非常出色的物料管理系统。
