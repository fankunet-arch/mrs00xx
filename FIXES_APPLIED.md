# å•é¡µé¢æé€Ÿæ”¶è´§ - ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-11-24
**å®¡è®¡äººå‘˜**: èµ„æ·±ä»£ç å®¡è®¡ä¸“å®¶
**ä»»åŠ¡çŠ¶æ€**: âœ… æ‰€æœ‰å‘ç°çš„é—®é¢˜å·²ä¿®å¤

---

## ğŸ“Š ä¿®å¤æ¦‚è§ˆ

| é—®é¢˜ç¼–å· | ä¸¥é‡ç¨‹åº¦ | é—®é¢˜æè¿° | çŠ¶æ€ |
|---------|---------|---------|------|
| é—®é¢˜ 1 | ğŸ”´ P0 | æ•°æ®åº“è¿æ¥é…ç½®ç¡¬ç¼–ç  | âœ… å·²ä¿®å¤ |
| é—®é¢˜ 2 | ğŸŸ¡ P1 | å€™é€‰åˆ—è¡¨åˆå§‹åŒ–ä¸ä¸€è‡´ | âœ… å·²ä¿®å¤ |
| é—®é¢˜ 3 | ğŸŸ¡ P1 | å€™é€‰åˆ—è¡¨ç¼ºå°‘é»˜è®¤éšè—æ ·å¼ | âœ… å·²ä¿®å¤ |
| é—®é¢˜ 4 | ğŸ”´ P0 | æ‰‹åŠ¨è¾“å…¥çš„ç‰©æ–™åç§°ä¸¢å¤± | âœ… å·²ä¿®å¤ |

---

## ğŸ”§ è¯¦ç»†ä¿®å¤å†…å®¹

### ä¿®å¤ 1: æ•°æ®åº“è¿æ¥é…ç½®æ”¯æŒç¯å¢ƒå˜é‡

**æ–‡ä»¶**: `/app/mrs/config_mrs/env_mrs.php`

**é—®é¢˜æè¿°**:
æ•°æ®åº“è¿æ¥å‚æ•°ç¡¬ç¼–ç ï¼Œæ— æ³•é€‚åº”ä¸åŒç¯å¢ƒï¼ˆæœ¬åœ°å¼€å‘ã€ç”Ÿäº§ç¯å¢ƒï¼‰ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
ä½¿ç”¨ç¯å¢ƒå˜é‡ä¼˜å…ˆï¼Œæ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–é»˜è®¤é…ç½®ï¼š

```php
// ä¿®å¤å‰
define('DB_HOST', 'mhdlmskp2kpxguj.mysql.db');
define('DB_NAME', 'mhdlmskp2kpxguj');

// ä¿®å¤å
define('DB_HOST', getenv('MRS_DB_HOST') ?: 'mhdlmskp2kpxguj.mysql.db');
define('DB_NAME', getenv('MRS_DB_NAME') ?: 'mhdlmskp2kpxguj');
```

**é…å¥—æ–‡ä»¶**:
- åˆ›å»ºäº† `.env.local.example` ç¤ºä¾‹æ–‡ä»¶
- å¼€å‘äººå‘˜å¯ä»¥å¤åˆ¶å¹¶ä¿®æ”¹ä¸ºæœ¬åœ°é…ç½®

**ä½¿ç”¨æ–¹æ³•**:
æœ¬åœ°å¼€å‘æ—¶ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ï¼š
```bash
export MRS_DB_HOST=localhost
export MRS_DB_NAME=mrs_local
export MRS_DB_USER=root
export MRS_DB_PASS=your_password
```

---

### ä¿®å¤ 2: å€™é€‰åˆ—è¡¨åˆå§‹åŒ–

**æ–‡ä»¶**: `/dc_html/mrs/js/receipt.js:450`

**é—®é¢˜æè¿°**:
- å¤–éƒ¨JSç‰ˆæœ¬æœªè°ƒç”¨ `renderCandidates()` è¿›è¡Œåˆå§‹åŒ–
- ç‹¬ç«‹HTMLç‰ˆæœ¬æœ‰è°ƒç”¨
- å¯¼è‡´ä¸¤ä¸ªç‰ˆæœ¬è¡Œä¸ºä¸ä¸€è‡´

**ä¿®å¤æ–¹æ¡ˆ**:
åœ¨ `initApp()` å‡½æ•°ä¸­æ·»åŠ  `renderCandidates()` è°ƒç”¨ï¼š

```javascript
// æ¸²æŸ“åˆå§‹ç•Œé¢
renderBatches();
renderBatchInfo();
renderUnits();
renderCandidates(); // [FIX] åˆå§‹åŒ–å€™é€‰åˆ—è¡¨ï¼ˆéšè—ç©ºåˆ—è¡¨ï¼‰
```

**å½±å“**:
- é¡µé¢åŠ è½½æ—¶æ­£ç¡®éšè—å€™é€‰åˆ—è¡¨
- ä¸¤ä¸ªç‰ˆæœ¬è¡Œä¸ºä¿æŒä¸€è‡´

---

### ä¿®å¤ 3: å€™é€‰åˆ—è¡¨é»˜è®¤éšè—æ ·å¼

**æ–‡ä»¶**: `/dc_html/mrs/css/receipt.css:107`

**é—®é¢˜æè¿°**:
CSSä¸­ `.candidate-list` ç¼ºå°‘ `display: none;` é»˜è®¤æ ·å¼ï¼Œä¾èµ–JSåŠ¨æ€è®¾ç½®ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
æ·»åŠ é»˜è®¤éšè—æ ·å¼ï¼š

```css
.candidate-list {
  margin-top: 10px;
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  display: none; /* é»˜è®¤éšè—ï¼Œç”±JSæ§åˆ¶æ˜¾ç¤º */
}
```

**å¥½å¤„**:
- å³ä½¿JSåŠ è½½å¤±è´¥æˆ–å»¶è¿Ÿï¼Œå€™é€‰åˆ—è¡¨ä¹Ÿä¸ä¼šé”™è¯¯æ˜¾ç¤º
- æå‡é¡µé¢åŠ è½½ä½“éªŒ
- é˜²æ­¢å‡ºç°ç©ºè¾¹æ¡†é—ªçƒ

---

### ä¿®å¤ 4: æ‰‹åŠ¨è¾“å…¥ç‰©æ–™åç§°ä¸¢å¤± âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
æ ¹æ®éœ€æ±‚æ–‡æ¡£ï¼Œç³»ç»Ÿåº”æ”¯æŒ"è‡ªç”±æ–‡æœ¬è¾“å…¥"ç‰©æ–™åç§°ï¼Œä½†å®ç°ä¸­ï¼š
1. å‰ç«¯å‘é€ `sku_name` å­—æ®µ
2. åç«¯å®Œå…¨å¿½ç•¥è¯¥å­—æ®µ
3. æ•°æ®åº“è¡¨ç¼ºå°‘å­˜å‚¨å­—æ®µ
4. å¯¼è‡´æ‰‹åŠ¨è¾“å…¥çš„ç‰©æ–™åç§°ä¸¢å¤±

**å½±å“**:
- ç”¨æˆ·è¾“å…¥"ç‰©æ–™A"ï¼ˆä¸é€‰SKUï¼‰â†’ ä¿å­˜åæ˜¾ç¤º"æœªçŸ¥ç‰©æ–™"
- **æ ¸å¿ƒåŠŸèƒ½ç¼ºé™·**ï¼šè¿åéœ€æ±‚è®¾è®¡åŸåˆ™

**ä¿®å¤æ–¹æ¡ˆ - 4æ­¥èµ°**:

#### æ­¥éª¤ 1: æ•°æ®åº“schemaæ›´æ–°

**æ–‡ä»¶**: `/docs/migrations/001_add_input_sku_name_to_raw_record.sql`

```sql
ALTER TABLE `mrs_batch_raw_record`
ADD COLUMN `input_sku_name` VARCHAR(255) NULL
COMMENT 'æ‰‹åŠ¨è¾“å…¥çš„ç‰©æ–™åç§°ï¼ˆå½“sku_idä¸ºNULLæ—¶ä½¿ç”¨ï¼‰'
AFTER `sku_id`;

CREATE INDEX `idx_input_sku_name` ON `mrs_batch_raw_record` (`input_sku_name`);
```

**æ‰§è¡Œè¦æ±‚**:
âš ï¸ **å¿…é¡»å…ˆæ‰§è¡Œæ­¤è¿ç§»è„šæœ¬ï¼Œå¦åˆ™ä¿å­˜è®°å½•ä¼šå¤±è´¥**

#### æ­¥éª¤ 2: APIæ¥æ”¶å¹¶ä¼ é€’å­—æ®µ

**æ–‡ä»¶**: `/app/mrs/api/save_record.php:81`

```php
$record_data = [
    'batch_id' => $input['batch_id'],
    'sku_id' => $input['sku_id'] ?? null,
    'input_sku_name' => $input['sku_name'] ?? null, // [FIX] ä¿å­˜æ‰‹åŠ¨è¾“å…¥çš„ç‰©æ–™åç§°
    'qty' => $input['qty'],
    // ...
];
```

#### æ­¥éª¤ 3: ä¿å­˜åˆ°æ•°æ®åº“

**æ–‡ä»¶**: `/app/mrs/lib/mrs_lib.php:205-232`

```php
$sql = "INSERT INTO mrs_batch_raw_record (
            batch_id,
            sku_id,
            input_sku_name,  // [FIX] æ–°å¢å­—æ®µ
            qty,
            ...
        ) VALUES (:batch_id, :sku_id, :input_sku_name, ...)";

$stmt->bindValue(':input_sku_name', $data['input_sku_name'] ?? null, PDO::PARAM_STR);
```

#### æ­¥éª¤ 4: æŸ¥è¯¢æ—¶ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥åç§°

**æ–‡ä»¶**: `/app/mrs/lib/mrs_lib.php:258-273`

```php
$sql = "SELECT
            r.input_sku_name,
            COALESCE(r.input_sku_name, s.sku_name) AS sku_name,  // [FIX] ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥
            ...
        FROM mrs_batch_raw_record r
        LEFT JOIN mrs_sku s ON r.sku_id = s.sku_id";
```

**é€»è¾‘è¯´æ˜**:
- å¦‚æœç”¨æˆ·é€‰æ‹©äº†SKU â†’ `sku_id` ä¸ä¸ºç©º â†’ æ˜¾ç¤ºSKUåç§°
- å¦‚æœç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ â†’ `sku_id` ä¸ºç©ºï¼Œ`input_sku_name` æœ‰å€¼ â†’ æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥
- COALESCEç¡®ä¿æ€»æ˜¯æœ‰ç‰©æ–™åç§°æ˜¾ç¤º

---

## ğŸ“‹ éƒ¨ç½²æ¸…å•

### âœ… å¿…é¡»æ‰§è¡Œçš„æ­¥éª¤

1. **æ•°æ®åº“è¿ç§»** (âš ï¸ æœ€é«˜ä¼˜å…ˆçº§)
   ```bash
   mysql -h mhdlmskp2kpxguj.mysql.db -u mhdlmskp2kpxguj -p mhdlmskp2kpxguj < docs/migrations/001_add_input_sku_name_to_raw_record.sql
   ```

2. **éƒ¨ç½²ä»£ç ** (åŒ…å«æ‰€æœ‰ä¿®å¤çš„æ–‡ä»¶)
   - `/app/mrs/config_mrs/env_mrs.php`
   - `/app/mrs/api/save_record.php`
   - `/app/mrs/lib/mrs_lib.php`
   - `/dc_html/mrs/js/receipt.js`
   - `/dc_html/mrs/css/receipt.css`

3. **ç¯å¢ƒé…ç½®** (æœ¬åœ°å¼€å‘æ—¶)
   - å¤åˆ¶ `.env.local.example` ä¸º `.env.local`
   - è®¾ç½®æœ¬åœ°æ•°æ®åº“è¿æ¥å‚æ•°

### ğŸ§ª æµ‹è¯•éªŒè¯

ä¿®å¤åéœ€è¦æµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š

#### åœºæ™¯ 1: æ‰‹åŠ¨è¾“å…¥ç‰©æ–™åç§°
1. è®¿é—®æ”¶è´§é¡µé¢
2. åœ¨ç‰©æ–™è¾“å…¥æ¡†ç›´æ¥è¾“å…¥"æµ‹è¯•ç‰©æ–™A"ï¼ˆä¸é€‰æ‹©å€™é€‰åˆ—è¡¨ï¼‰
3. è¾“å…¥æ•°é‡å’Œå•ä½
4. ä¿å­˜è®°å½•
5. **éªŒè¯**: è®°å½•åˆ—è¡¨ä¸­æ˜¾ç¤º"æµ‹è¯•ç‰©æ–™A"ï¼ˆä¸æ˜¯"æœªçŸ¥ç‰©æ–™"ï¼‰

#### åœºæ™¯ 2: é€‰æ‹©SKU
1. æœç´¢å¹¶é€‰æ‹©ä¸€ä¸ªSKU
2. è¾“å…¥æ•°é‡å’Œå•ä½
3. ä¿å­˜è®°å½•
4. **éªŒè¯**: è®°å½•æ˜¾ç¤ºSKUåç§°

#### åœºæ™¯ 3: å€™é€‰åˆ—è¡¨æ˜¾ç¤º
1. è®¿é—®é¡µé¢
2. **éªŒè¯**: å€™é€‰åˆ—è¡¨åˆå§‹çŠ¶æ€ä¸å¯è§
3. è¾“å…¥æœç´¢å…³é”®è¯
4. **éªŒè¯**: å€™é€‰åˆ—è¡¨æ­£ç¡®æ˜¾ç¤º

#### åœºæ™¯ 4: ç¯å¢ƒå˜é‡é…ç½®
1. æœ¬åœ°è®¾ç½®ç¯å¢ƒå˜é‡
2. è®¿é—®é¡µé¢
3. **éªŒè¯**: ä½¿ç”¨æœ¬åœ°æ•°æ®åº“è¿æ¥

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ COALESCE?

```sql
COALESCE(r.input_sku_name, s.sku_name) AS sku_name
```

**åŠŸèƒ½**: è¿”å›ç¬¬ä¸€ä¸ªéNULLå€¼

**ä¸šåŠ¡é€»è¾‘**:
1. ä¼˜å…ˆä½¿ç”¨ `input_sku_name`ï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰
2. å¦‚æœä¸ºç©ºï¼Œä½¿ç”¨ `s.sku_name`ï¼ˆSKUå…³è”ï¼‰
3. ç¡®ä¿æ€»æœ‰ç‰©æ–™åç§°æ˜¾ç¤º

### ä¸ºä»€ä¹ˆéœ€è¦ç´¢å¼•?

```sql
CREATE INDEX `idx_input_sku_name` ON `mrs_batch_raw_record` (`input_sku_name`);
```

**åŸå› **:
- åç»­å¯èƒ½éœ€è¦æŒ‰ç‰©æ–™åç§°æœç´¢æˆ–åˆ†ç»„
- æå‡æŸ¥è¯¢æ€§èƒ½
- æœ€ä½³å®è·µ

### ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§

```php
getenv('MRS_DB_HOST') ?: 'mhdlmskp2kpxguj.mysql.db'
```

**æœºåˆ¶**:
1. å°è¯•ä»ç¯å¢ƒå˜é‡è¯»å–
2. å¦‚æœæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼ˆç”Ÿäº§ç¯å¢ƒé…ç½®ï¼‰
3. é›¶é…ç½®éƒ¨ç½²ï¼Œçµæ´»å¼€å‘

---

## ğŸ¯ ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰
- âŒ æ•°æ®åº“è¿æ¥ç¡¬ç¼–ç ï¼Œæœ¬åœ°å¼€å‘å›°éš¾
- âŒ å€™é€‰åˆ—è¡¨åˆå§‹çŠ¶æ€ä¸ä¸€è‡´
- âŒ æ‰‹åŠ¨è¾“å…¥çš„ç‰©æ–™åç§°ä¸¢å¤±
- âŒ æ ¸å¿ƒåŠŸèƒ½"è‡ªç”±æ–‡æœ¬è¾“å…¥"ä¸å¯ç”¨

### ä¿®å¤å
- âœ… æ”¯æŒç¯å¢ƒå˜é‡é…ç½®ï¼Œçµæ´»é€‚é…ä¸åŒç¯å¢ƒ
- âœ… é¡µé¢è¡Œä¸ºä¸€è‡´ï¼Œç”¨æˆ·ä½“éªŒè‰¯å¥½
- âœ… æ‰‹åŠ¨è¾“å…¥çš„ç‰©æ–™åç§°æ­£ç¡®ä¿å­˜å’Œæ˜¾ç¤º
- âœ… ç¬¦åˆéœ€æ±‚è®¾è®¡åŸåˆ™
- âœ… ä»£ç è´¨é‡æå‡ï¼Œå¯ç»´æŠ¤æ€§å¢å¼º

---

## ğŸ“ ä»£ç å®¡è®¡æ€»ç»“

### å®¡è®¡èŒƒå›´
- âœ… å‰ç«¯é¡µé¢ (HTML/CSS/JS)
- âœ… åç«¯API (PHP)
- âœ… æ•°æ®åº“æ“ä½œ
- âœ… å®‰å…¨æ€§æ£€æŸ¥
- âœ… é€»è¾‘å®Œæ•´æ€§
- âœ… éœ€æ±‚ç¬¦åˆæ€§

### å‘ç°é—®é¢˜ç»Ÿè®¡
- ğŸ”´ P0çº§ä¸¥é‡é—®é¢˜: 2ä¸ª (å·²ä¿®å¤)
- ğŸŸ¡ P1çº§é«˜ä¼˜å…ˆçº§: 2ä¸ª (å·²ä¿®å¤)
- ğŸ”µ P2çº§ä¸­ä¼˜å…ˆçº§: 2ä¸ª (è®¡åˆ’ä¸­)

### æœªä¿®å¤é—®é¢˜
ä»¥ä¸‹é—®é¢˜ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼Œå¯ä»¥åç»­è¿­ä»£ï¼š
1. **æ“ä½œå‘˜ä¿¡æ¯ç¡¬ç¼–ç ** - éœ€è¦å®ç°ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
2. **ç¼ºå°‘CSRFé˜²æŠ¤** - éœ€è¦æ·»åŠ å®‰å…¨ä»¤ç‰Œæœºåˆ¶

---

## âœ… éªŒæ”¶æ ‡å‡†

ä¿®å¤å®Œæˆåï¼Œç³»ç»Ÿåº”æ»¡è¶³ï¼š
1. âœ… å¯ä»¥åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒè¿è¡Œ
2. âœ… æ‰‹åŠ¨è¾“å…¥çš„ç‰©æ–™åç§°èƒ½æ­£ç¡®ä¿å­˜å’Œæ˜¾ç¤º
3. âœ… å€™é€‰åˆ—è¡¨è¡Œä¸ºæ­£ç¡®
4. âœ… æ‰€æœ‰APIåŠŸèƒ½æ­£å¸¸
5. âœ… ç¬¦åˆåŸå§‹éœ€æ±‚è®¾è®¡

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- **å®¡è®¡æŠ¥å‘Š**: `AUDIT_REPORT.md`
- **é—®é¢˜æ¸…å•**: `ISSUES_FOUND.md`
- **æ•°æ®åº“è¿ç§»**: `docs/migrations/001_add_input_sku_name_to_raw_record.sql`
- **ç¯å¢ƒé…ç½®ç¤ºä¾‹**: `.env.local.example`

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-24
**ä¿®å¤ç‰ˆæœ¬**: v1.0.1-audit-fixes
**ä¿®å¤äººå‘˜**: èµ„æ·±ä»£ç å®¡è®¡ä¸“å®¶
**ä¿®å¤çŠ¶æ€**: âœ… æ‰€æœ‰ä¸¥é‡é—®é¢˜å·²ä¿®å¤ï¼Œå¯ä»¥éƒ¨ç½²
